

<!DOCTYPE html>
<html>

<!-- Mirrored from timmyomahony.com/blog/django-and-circleci-2/ by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 03 Feb 2020 07:53:24 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <meta name='description' content="">
  <meta name='keywords' content=''>  
  <title>Django and CircleCI 2.0</title>
  
  

<link rel="apple-touch-icon" sizes="180x180" href="../../static/images/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../static/images/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../static/images/favicon/favicon-16x16.png">
<link rel="manifest" href="../../static/images/favicon/site.webmanifest">
<link rel="mask-icon" href="../../static/images/favicon/safari-pinned-tab.svg" color="#67d38a">
<meta name="msapplication-TileColor" content="#67d38a">
<meta name="theme-color" content="#67d38a">
  
  <link rel="stylesheet" href="../../static/css/styles.min.css" type="text/css" charset="utf-8">
  
</head>
<body class='' data-component='body'>
  <div class='page'>
    





<div class='header-wrapper ' data-component='header'>
  <div class='container'>
    <div class='row'>
      <div class='col-xs-12'>
        <header class='header'>
          <div class='header-logo'>
            <a class='header-image' href='../../index.html'>
              <img class='header-image__img' src="../../static/images/timmy-omahony-portrait-small.png" alt="Timmy O&#39;Mahony">
            </a>
            <div class="header-text">
              <a class='header-title link--dark link--no-underline' href='../../index.html'>
                Timmy O&#39;Mahony
              </a>
              <p class='header-subtitle color-xs-light-gray'>
                Software Development
              </p>
            </div>
          </div>
          <nav class='header-nav'>
            <ul class='header-nav__list'>
              <li class='header-nav__item'>
                <a class='header-nav__link ' href='../../index.html'>
                  About
                </a>
              </li>
              <li class='header-nav__item'>
                <a class='header-nav__link header-nav__link--active' href='../index.html'>
                  Blog
                </a>
              </li>
              <li class='header-nav__item hide-xs show-sm'>
                <a class='header-nav__link header-nav__link--light' href='mailto:hey@timmyomahony.com'>
                  hey@timmyomahony.com
                </a>
              </li>
            </ul>
          </nav>
          <button class='header-hamburger button--reset clickable' data-header-hamburger>
            <svg class="svg svg--hamburger" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
              viewBox="0 0 298 87.011" enable-background="new 0 0 298 87.011" xml:space="preserve">
              <rect x="0" fill="#282828" width="298" height="21.505"/>
              <rect y="65.506" fill="#282828" width="298" height="21.505"/>
            </svg>
          </button>
        </header>
      </div>
    </div>
  </div>
  <div class='header-overlay' data-nav-overlay>
    <div class='header-overlay__close' data-header-overlay-close>
      <button class='button button--reset'>
        <svg class='clickable' version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 327.688 327.681" enable-background="new 0 0 327.688 327.681"
           xml:space="preserve">
        <path fill="#231F20" d="M3.004,324.691c1.997,1.997,4.618,2.99,7.24,2.99s5.243-1.004,7.25-3.001l146.35-146.523l146.35,146.523
          c1.997,2.008,4.618,3.001,7.25,3.001c2.621,0,5.243-1.004,7.239-2.99c4.004-3.993,4.004-10.476,0.011-14.479l-146.207-146.37
          L324.684,17.48c3.994-4.003,3.994-10.485-0.01-14.479c-4.015-4.004-10.486-4.004-14.479,0.01l-146.36,146.524L17.484,3.012
          C13.48-0.992,6.998-0.992,3.004,3.001C-1,6.995-1,13.477,2.994,17.48l146.187,146.361L2.994,310.211
          C-1,314.206-1,320.698,3.004,324.691z"/>
        </svg>
      </button>
    </div>
    <div class='header-nav'>
      <ul class='header-nav__list'>
        <li class='header-nav__item'>
          <a class='header-nav__link ' href='../../index.html'>
            About
          </a>
        </li>
        <li class='header-nav__item'>
          <a class='header-nav__link header-nav__link--active' href='../index.html'>
            Blog
          </a>
        </li>
        <li class='header-nav__item'>
          <a class='header-nav__link ' href='../../projects/featured/index.html'>
            Projects
          </a>
        </li>
        <li class='header-nav__item'>
          <a class='header-nav__link header-nav__link--light' href='mailto:hey@timmyomahony.com'>
            hey@timmyomahony.com
          </a>
        </li>
      </ul>
    </div>
  </div>
</div>

    <main class='main'>
      
  <section class='container mt-xs-20 mt-sm-40 mb-xs-120'>
    <div class='row'>
      <div class='col-xs-12 col-md-8 col-md-offset-2'>
        
        
          
        
        

<article class='content-item'>
  <header class='content-item__header'>
    <h1 class='content-item__title'>
      Django and CircleCI 2.0
    </h1>
    
      <p class='content-item__subtitle'>
        <time class='content-item__date' datetime='' itemprop='datePublished'>
          May 1, 2019
        </time>&mdash;
      </p>
    
  </header>
  
    <figure class='content-item__image image mb-xs-60' data-component='image'>
      <span class='image__content'>
        
          <img class='image__img lazyload' data-src='../../media/filer_public/aa/91/aa91849f-924a-43cf-9dd4-e02e70b4bef6/hans-peter-gauster-252751-unsplash.jpg'>
        
      </span>
    </figure>
  
  <div class='content-item__body user-content'>
    <p>Using Continuous Integration with your project is a great way to deploy features and fixes automatically, without having to faff around SSHing into machines, manually pulling down changes and restarting servers. The killer feature though is being able to automatically <strong>test</strong> your project before those changes are automatically pulled.</p>

<p>I use <a href="https://circleci.com/">CircleCI</a> for this, so in this post I&#8217;ll show you how to deploy a standard Django project (or any Python project really) using CircleCI. This is certainly not the only way to do this, but it&#8217;s what works for me.</p>

<p>If you&#8217;ve got any improvements or criticisms of this approach, please add them in the comments - I&#8217;m interested to hear how other people are handling this.</p>

<h2>Overview</h2>

<p>Here&#8217;s my usual flow between CircleCI and GitHub when making changes to my projects:</p>

<p><img src="../../media/filer_public/50/f9/50f92edc-6081-41a1-bb55-3e9fd279ad64/screenshot_2019-04-16_at_103134.png" alt="" /></p>

<p>Simple right! OK, so it looks complicated, but there are three main stages:</p>

<ol>
<li>I push my code</li>
<li>CircleCI pull my code, builds it and tests it</li>
<li>CircleCI deploys my code</li>
</ol>

<p>Here&#8217;s what happens in more detail:</p>

<ul>
<li>I start with my <code>develop</code> and <code>master</code> branches on GitHub</li>
<li>I push changes to <code>develop</code> branch from my local machine</li>
<li>GitHub informs CircleCI (via post commit hooks) that there are new changes for my project</li>
<li>CircleCI creates a new temporary server instance on <em>their</em> infrastructure</li>
<li>CircleCI pulls down my latest commit from Github to that temporary server instance</li>
<li>CirleCI read the <code>config.yml</code> configuration file in my repo</li>
<li>CircleCI builds my code and runs tests according to the commands I&#8217;ve included in above configuration file</li>
<li>If tests pass, CircleCI deploys the changes to <em>my infrastructure</em> (i.e. my staging server) via SSH and <a href="https://www.fabfile.org/">Fabric</a></li>
<li>I then manually create a pull request for review on Github</li>
<li>Once this is reviewed and merged to <code>master</code>, the process is repeated for my production server instance</li>
</ul>

<h2>Project repo</h2>

<p>Before we start, we need a GitHub repository that we are interested in automatically deploying somewhere. In this example, I&#8217;m using my own public <a href="https://github.com/timmyomahony/django-circleci-example">django-circleci-example repo that you can see on my GitHub profile</a> and I&#8217;m deploying it to my own Linode server. This example Django project was set up using <a href="https://github.com/pydanny/cookiecutter-django">Django Cookiecutter</a>.</p>

<p>Your project is probably deployed on your servers a little bit differently so keep that in mind when we come to creating our CicleCI configuration files.</p>

<h2>CircleCI project setup</h2>

<p>First thing is to add our project to CircleCI. CircleCI should be smart enough to show you all of the repos you&#8217;ve got in your GitHub account. If you&#8217;ve only just created the repo, you might need to wait a few minutes and refresh:</p>

<p><img src="../../media/filer_public/86/d3/86d35632-a43c-45a0-b625-6e0ac93d64c4/screenshot_2019-04-13_at_182402.png" alt="Screenshot 1" /></p>

<p>Select &#8220;Linux&#8221;, &#8220;Python&#8221; and &#8220;Start Building&#8221;</p>

<p><img src="../../media/filer_public/bc/ea/bcea2738-dd31-4411-b1b9-0273bfbbd644/screenshot_2019-04-13_at_182415.png" alt="Screenshot 2" /></p>

<p>.. and then watch everything fail immediately. This is because we haven&#8217;t yet provided a CircleCI configuration file. You will receive an email:</p>

<p><img src="../../media/filer_public/5f/a4/5fa404e7-bed5-40fa-bccc-dc60c8d076f4/screenshot_2019-04-13_at_182442.png" alt="Screenshot 3" /></p>

<p>You&#8217;ll then see your first failed build on the dashboard:</p>

<p><img src="../../media/filer_public/de/62/de622c47-8df3-4651-8034-138ec8bace07/screenshot_2019-04-13_at_182453.png" alt="Screenshot 4" /></p>

<p>For CircleCI to know what it should do, we need to provide it with a configuration YAML file. We do this be creating a <code>.circle</code> folder in the root of our repo and then creating a <code>config.yml</code> file that makes use of a certain syntax. </p>

<h3>How everything communicates</h3>

<p>Before going any further, let&#8217;s think about how GitHub, CircleCI and our own servers are going to communicate:</p>

<ol>
<li>CircleCI needs to be able to pull down our repo from GitHub to <em>its</em> servers</li>
<li>CircleCI also needs to be able to SSH into <em>our</em> server to deploy the changes</li>
<li>While SSHed into our server CircleCI needs to be able to pull down our codebase from GitHub</li>
</ol>

<p>For this to work, we need a number of public/private keypairs:</p>

<ol>
<li>CircleCI will have access to our repo via a <a href="https://developer.github.com/v3/guides/managing-deploy-keys/#deploy-keys">GitHub deploy key</a>. This will allow read-only access to the repo.</li>
<li>For CircleCI to access <em>our</em> server from <em>their</em> server, we&#8217;ll need to generate a passphraseless keypair and add it to the CircleCI project settings</li>
<li>For our servers to access our GitHub repo, we&#8217;ll need another GitHub read-only deploy key. Unlike the first deploy key, we&#8217;ll need to create this manually.</li>
</ol>

<h5>1. CircleCI to GitHub</h5>

<p>This deploy key is automatically created when you add a new project to CircleCI. GitHub will send you an email to notify of this, but you will also see the keypair in both the CircleCI project settings as well as your GitHub repo settings:</p>

<p><img src="../../media/filer_public/ef/4a/ef4ac728-a870-4cda-9a68-e8a1be0478f0/screenshot_2019-04-13_at_182504.png" alt="Screenshot 5" /></p>

<p><img src="../../media/filer_public/2a/6a/2a6ad2ca-ac0d-4af1-b588-7f3ae5dcc3a7/screenshot_2019-04-13_at_182515.png" alt="Screenshot 6" /></p>

<h5>2. CircleCI to our server</h5>

<p>Ideally we would generate this key on the actual CircleCI server instance, so that the private key never leaves the machine. Unfortunately that&#8217;s not possible here, as the CircleCI server instances are created and destroyed everytime changes are detected.</p>

<p>Instead, we create the keypair locally and add the private key to the CircleCi project settings. CircleCI will then inject this private key into every new build instance that is created.</p>

<p>So, on our local machine, generate a new <strong>passphraseless</strong> keypair using:</p>

<div class="codehilite"><pre><span></span><code><span class="nv">$local</span>&gt; ssh-keygen -m PEM -t rsa -C <span class="s2">&quot;root@circleci&quot;</span>
</code></pre></div>

<p>It&#8217;s important to use <code>-m PEM -t rsa</code> here due to a bug with CircleCI documented on <a href="https://discuss.circleci.com/t/adding-ssh-keys-fails/7747/24">their forums</a>. It&#8217;s also important that we don&#8217;t add a passphrase to this key. Doing so would prevent CircleCI from deploying our changes, as the SSH session would hang on connection while waiting for the passphrase prompt.</p>

<p>We then add the <em>private key</em> to our project settings:</p>

<p><img src="../../media/filer_public/f8/8a/f88a1cda-b6b7-4b6a-a7de-46b44c69e19d/screenshot_2019-04-16_at_113123.png" alt="Screenshot" /></p>

<p>Then log into our server instance and add the public key to <code>~/.ssh/authorized_keys</code>.</p>

<p>NOTE: Depending on your setup, for you to login to your server instance may require a fourth SSH key 😭!</p>

<h5>3. Our server to Github</h5>

<p>Finally, we need to add another deploy key to allow our server to pull changes from Github. While still logged into our server instance, create another keypair:</p>

<div class="codehilite"><pre><span></span><code><span class="nv">$server</span>&gt; ssh-keygen -t rsa -b <span class="m">4096</span> -C <span class="s2">&quot;root@server-instance&quot;</span>
</code></pre></div>

<p>Again, make sure this is passphraseless when completing the steps. We then copy the <em>public key</em> at <code>~/.ssh/id_rsa.pub</code> to our Github repo settings:</p>

<p><img src="../../media/filer_public/36/fc/36fc76e2-19c6-4d29-9d79-7d237721a8ed/screenshot_2019-04-16_at_113945.png" alt="Screenshot" /></p>

<p>We then configure SSH on our server to use the correct <em>private key</em>:</p>

<div class="codehilite"><pre><span></span><code><span class="nv">$server</span>&gt; vim ~/.ssh/config
</code></pre></div>

<p>and adding:</p>

<pre><code>ServerAliveInterval 60
ServerAliveCountMax 100
TCPKeepAlive yes
IdentitiesOnly yes

Host github.com
    Hostname github.com
    IdentityFile ~/.ssh/id_rsa
</code></pre>

<p>You can then clone the repo to your server:</p>

<div class="codehilite"><pre><span></span><code><span class="nv">$server</span>&gt; git clone git@github.com:timmyomahony/django-circleci-example.git
</code></pre></div>

<p>NOTE: If you have multiple repos on the same host, you can check out <a href="https://snipe.net/2013/04/11/multiple-github-deploy-keys-single-server/">this post on how to handle multiple deploy keys</a>.</p>

<h2>Circle CI configuration and deployment files</h2>

<p>Phew. Next up we need to create our configuration files. These files will exist within our repo, in a <code>.circleci</code> folder. The two files we need are:</p>

<ul>
<li>a <code>config.yml</code> YAML file that CircleCI will use to build our app for testing</li>
<li>a Fabric <code>deploy.py</code> &#8220;fabfile&#8221; that CircleCI will use for deployment to our server</li>
</ul>

<p><img src="../../media/filer_public/4f/f4/4ff4afea-39a8-4367-bdda-f200162ce1b0/screenshot_2019-05-02_at_140756.png" alt="Screenshot" /></p>

<h3>Our buid configuration</h3>

<p>So back on our local machine, create a <code>.circleci</code> folder in the root of our repo:</p>

<div class="codehilite"><pre><span></span><code><span class="nv">$local</span>&gt; mkdir .circleci
</code></pre></div>

<p>And add the <code>config.yml</code> file:</p>

<div class="codehilite"><pre><span></span><code><span class="nv">$local</span>&gt; vim .circleci/config.yml
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="nt">jobs</span><span class="p">:</span>
  <span class="nt">build-job</span><span class="p">:</span>
    <span class="nt">docker</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">circleci/python:3.7.3</span>
      <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">circleci/postgres:10.5</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="nt">DATABASE_URL</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres://postgres:@localhost/circle_test</span>
      <span class="nt">DJANGO_SECRET_KEY</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">test</span>
      <span class="nt">DJANGO_READ_DOT_ENV_FILE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
      <span class="nt">DJANGO_SETTINGS_MODULE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config.settings.test</span>
    <span class="nt">working_directory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">~/app</span>
    <span class="nt">steps</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">checkout</span>
      <span class="p p-Indicator">-</span> <span class="nt">restore_cache</span><span class="p">:</span>
          <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v001-app-{{ .Branch }}-{{ checksum &quot;requirements/local.txt&quot; }}</span>
      <span class="p p-Indicator">-</span> <span class="nt">run</span><span class="p">:</span>
          <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install Python dependencies</span>
          <span class="nt">command</span><span class="p">:</span> <span class="p p-Indicator">|</span>
            <span class="no">python3 -m venv venv</span>
            <span class="no">. venv/bin/activate</span>
            <span class="no">pip install -r requirements/local.txt</span>
      <span class="p p-Indicator">-</span> <span class="nt">save_cache</span><span class="p">:</span>
          <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v001-app-{{ .Branch }}-{{ checksum &quot;requirements/local.txt&quot; }}</span>
          <span class="nt">paths</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="s">&#39;venv&#39;</span>
      <span class="p p-Indicator">-</span> <span class="nt">run</span><span class="p">:</span>
          <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Add python project to path</span>
          <span class="nt">command</span><span class="p">:</span> <span class="s">&#39;echo</span><span class="nv"> </span><span class="s">&quot;$(realpath</span><span class="nv"> </span><span class="s">.)/app&quot;</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">venv/lib/python3.7/site-packages/app.pth&#39;</span>
      <span class="p p-Indicator">-</span> <span class="nt">run</span><span class="p">:</span>
          <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Run tests</span>
          <span class="nt">command</span><span class="p">:</span> <span class="p p-Indicator">|</span>
            <span class="no">. venv/bin/activate</span>
            <span class="no">python manage.py test</span>
  <span class="nt">deploy-job</span><span class="p">:</span>
    <span class="nt">docker</span><span class="p">:</span>
      <span class="c1"># Important to note that we&#39;re using 2.7 here. This is because at the time of</span>
      <span class="c1"># writing, Fabric doesn&#39;t work with Python 3</span>
      <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">circleci/python:2.7</span>
    <span class="nt">working_directory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">~/app</span>
    <span class="nt">steps</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">checkout</span>
      <span class="p p-Indicator">-</span> <span class="nt">run</span><span class="p">:</span>
          <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deploy via Fabric</span>
          <span class="nt">command</span><span class="p">:</span> <span class="p p-Indicator">|</span>
            <span class="no">sudo pip install fabric==1.14.0</span>
            <span class="no">if [ &quot;${CIRCLE_BRANCH}&quot; == &quot;master&quot; ]; then</span>
              <span class="no">fab -f .circleci/deploy.py -i ~/.ssh/id_rsa production deploy</span>
            <span class="no">else</span>
              <span class="no">fab -f .circleci/deploy.py -i ~/.ssh/id_rsa staging deploy</span>
            <span class="no">fi</span>


<span class="nt">workflows</span><span class="p">:</span>
  <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
  <span class="nt">build-deploy</span><span class="p">:</span>
    <span class="nt">jobs</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">build-job</span><span class="p">:</span>
          <span class="nt">filters</span><span class="p">:</span>
            <span class="nt">branches</span><span class="p">:</span>
              <span class="nt">only</span><span class="p">:</span>
                <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">develop</span>
                <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">master</span>
      <span class="p p-Indicator">-</span> <span class="nt">deploy-job</span><span class="p">:</span>
          <span class="nt">requires</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">build-job</span>
          <span class="nt">filters</span><span class="p">:</span>
            <span class="nt">branches</span><span class="p">:</span>
              <span class="nt">only</span><span class="p">:</span>
                <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">develop</span>
                <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">master</span>
</code></pre></div>

<p>At a high level, you create your deployments via &#8220;workflows&#8221;, &#8220;jobs&#8221; and &#8220;steps&#8221;. A workflow has one or more jobs and a job has one or more steps. In our workflow, we have two jobs:</p>

<ul>
<li>A &#8220;build&#8221; job that builds our app on a temporary server and tests it</li>
<li>A &#8220;deploy&#8221; job that uses Fabric to deploy our app to our servers</li>
</ul>

<p>Our &#8220;deploy&#8221; job is dependant on our &#8220;build&#8221; job. In other words, if our &#8220;build&#8221; job fails because our tests didn&#8217;t pass, it won&#8217;t be deployed to our servers.</p>

<p>This is a very simple example of a CircleCI configuration. Have a look <a href="https://circleci.com/docs/2.0/configuration-reference/">at their documentation</a> to find out more of the possibilities available.</p>

<p>Let&#8217;s go over some of the details:</p>

<ul>
<li><strong>Docker images</strong>: CircleCI uses Docker when creating its server instances so you need to tell it which Docker images you want to use in your configuration. I&#8217;ve choosen Python 3.7.3 and Postgres 10.5, but there are many other images available to use. For example, you might want to use Postgis if you have a GeoDjango project. You can see <a href="https://circleci.com/docs/2.0/docker-image-tags.json">a list of available Docker images in CircleCI here</a>.</li>
<li><strong>Environments</strong>: You&#8217;ll see that we are configured to handle two environments: &#8220;staging&#8221; and &#8220;production&#8221;. Depending on which branch we push to, our app will be built for either staging or production. In our case these deployments are very similar (as we always want staging to be as close to production as possible for testing purposes) but it&#8217;s possible you might want to vary your setup depending on your environments. </li>
<li><strong>Variables</strong>: The configuration gives you the opportunity to inject environment variables into the build which is very useful if your Django project depends on them for its settings. In our configuration above we are using the environment variables required by Django Cookiecutter. This works OK for non-sensitive environment variables, but you wouldn&#8217; t want to include any secret keys or API keys here. If you sensitive values, you can also inject these environment variables into your builds via the project settings.</li>
<li><strong>Caching</strong>: CircleCI allows you to cache things to speed up your build. We&#8217;re saving our virtual environment to the cache. It will only be invalidated if our project requirements change or if we manually change the <code>v001-app</code> used in the cache step. </li>
</ul>

<h2>Our deployment configuration</h2>

<p>Again, for the deployment job we&#8217;re using Fabric. It&#8217;s worth pointing out that we&#8217;re not using any built-in deployment approach from CircleCI. We&#8217;ve just configured a job called <code>deploy-job</code> that runs a Fabic script. It&#8217;s Fabric itself that will be handling the actual deployment steps.</p>

<p>Also, <strong>it&#8217;s highly likely your Fabric configuration will be different to the example below</strong>, as it depends on how the Django project is set up on your server.</p>

<p>My deployment looks like:</p>

<ul>
<li>Repo saved at <code>~/django-circleci-example</code></li>
<li>Using <code>virtualenv</code> and <code>virtualenv-wrapper</code>. My virtual environment is called <code>django-circleci-example</code> and is saved in <code>~/.virtualenvs/django-circleci-example</code></li>
<li>Using Nginx as the proxy</li>
<li>Using Gunicorn as the application server</li>
<li>Using Supervisord to manage the processes</li>
</ul>

<p>With that in mind, here is the Fabric <code>deploy.py</code> configuration that we&#8217;ll add to the repo:</p>

<div class="codehilite"><pre><span></span><code><span class="nv">$local</span>&gt; vim .circleci/deploy.py
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/python2</span>

<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">env</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">task</span>

<span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Fabric deploy script</span>

<span class="sd">This is a Fabric (python 2.7) deployment script to be used by CircleCI to</span>
<span class="sd">deploy this project automatically to either production or staging.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">paramiko</span>
    <span class="n">paramiko</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">paramiko</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="n">env</span><span class="o">.</span><span class="n">venv_name</span> <span class="o">=</span> <span class="s1">&#39;django-circleci-example&#39;</span>
<span class="n">env</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;~/django-circleci-example&#39;</span>
<span class="n">env</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;admin&#39;</span>


<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">production</span><span class="p">():</span>
    <span class="n">env</span><span class="o">.</span><span class="n">branch</span> <span class="o">=</span> <span class="s1">&#39;master&#39;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timmyomahony.com&#39;</span><span class="p">,</span> <span class="p">]</span>


<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">staging</span><span class="p">():</span>
    <span class="n">env</span><span class="o">.</span><span class="n">branch</span> <span class="o">=</span> <span class="s1">&#39;develop&#39;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timmyomahony.com&#39;</span><span class="p">,</span> <span class="p">]</span>


<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">venv</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="n">run</span><span class="p">(</span><span class="s1">&#39;workon </span><span class="si">{0}</span><span class="s1"> &amp;&amp; </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">venv_name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>


<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">deploy</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
        <span class="n">run</span><span class="p">(</span><span class="s1">&#39;git pull origin </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">branch</span><span class="p">))</span>
        <span class="n">venv</span><span class="p">(</span><span class="s1">&#39;pip install -r requirements/production.txt&#39;</span><span class="p">)</span>
        <span class="n">venv</span><span class="p">(</span><span class="s1">&#39;python manage.py migrate&#39;</span><span class="p">)</span>
        <span class="n">venv</span><span class="p">(</span><span class="s1">&#39;python manage.py collectstatic --noinput&#39;</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="s1">&#39;supervisorctl reread&#39;</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="s1">&#39;supervisorctl update&#39;</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="s1">&#39;supervisorctl restart django-circleci-example&#39;</span><span class="p">)</span>
</code></pre></div>

<p>At this point, you should be good-to-go. All you need to do is push changes to your <code>develop</code> branch and your app should be automatically built and deployed.</p>

<p>This is only scratching the surface of what&#8217;s available in CircleCI. If you&#8217;ve got any suggestions or criticisms, I&#8217;d love to hear about them below in the comments.</p>

  </div>
  <footer class='content-item__footer mt-xs-80'>
    <p class='list-item__tags'>
      
        <a href='../category/web-development/index.html'>Web Development</a> &mdash;
      
      
        
          <a href='../tag/django/index.html'>Django</a>,
        
          <a href='../tag/circleci/index.html'>CircleCI</a>
        
      
    </p>
    
      <p class='list-item__tags'>
        Last edited 4 months, 3 weeks ago
      </p>
        
  </footer>
</article>
      </div>
    </div>
    
      <footer class='row'>   
        <div class='col-xs-12 col-md-8 col-md-offset-2 center-xs mt-xs-80'>
          <a class='button' href='#' data-component='comments'>
            Load Comments
          </a>
          <div id='disqus_thread'></div>
        </div>
      </footer>
    
  </section>

    </main>
    
    

<footer class='footer'>
  <div class='container'>
    <div class='row mb-xs-40 mb-sm-60'>
      <div class='col-xs-12 col-md-5'>
        <h3>Timmy O&#39;Mahony</h3>
        <p><a class='email' href='mailto:hey@timmyomahony.com'>hey@timmyomahony.com</a></p>
        <p>I’m a software developer. I can help you solve 
        a problem, build a product or grow existing project.</p>
      </div>
    </div>

    <div class='row mb-xs-40 mb-ms-80'>
      
      <div class='col-xs-12 col-sm-6 col-md-4 mb-xs-40'>
        <h4 class='mb-xs-20 mb-sm-40'>Menu</h4>
        <div class="row">
          <div class="col-xs-6">
            <ul class='list--reset'>
              <li>
                <a href='../../index.html'>About</a>
              </li>
              <li>
                <a href='../index.html'>Blog</a>
              </li>
              <li>
                <a href='../../projects/featured/index.html'>Projects</a>
              </li>
              <li>
                <span>&mdash;</span>
              </li>
              <li>
                <a href='../../privacy/index.html'>Privacy</a>
              </li>
            </ul>
          </div>
          <div class="col-xs-6">
            <ul class='list--reset'>
              <li>
                <a class="link--dark" href='../../books/index.html'>Books</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      
      <div class='col-xs-12 col-sm-6 col-md-4 col-md-offset-1 mb-xs-40'>
        <h4 class='mb-xs-20 mb-sm-40'>Contact</h4>
        <ul class='list--reset'>
          <li>
            <a href='mailto:hey@timmyomahony.com'>
              hey@timmyomahony.com
            </a>
            <a class="link--dark" href='../../pgp-key/index.html'>
              (pgp)
            </a>
          </li>
          <li>
            <a href='skype:live:timmyomahony' target='_blank' title='Skype me'>
              Skype
            </a>
          </li>
        </ul>
      </div>
      
      <div class='col-xs-12 col-sm-6 col-md-3 mb-xs-40'>
        <h4 class='mb-xs-20 mb-sm-40'>Online</h4>
        <ul class='list--reset'>
          <li>
            <a href='https://github.com/timmyomahony/' target='_blank' title='Look through my Github profile'>
              Github
            </a>
          </li>
          <li>
            <a href='https://twitter.com/timmyomahony/' target='_blank' title='Look through my Twitter profile'>
              Twitter
            </a>
          </li>
          <li>
            <a href='http://stackoverflow.com/users/396300/timmy-omahony' target='_blank' title='See my Stack Overflow profile'>
              Stack Overflow
            </a>
          </li>
        </ul>
      </div>
    </div>
    
    <div class='row'>
      <div class='col-xs-12'>
        <p class='copyright'>Copyright Timmy O’Mahony 2020 &copy; <a class='link--underline' href='../../about-this-site/index.html'>More information</a>  — <a class='link--dark' href='../../changelog/index.html'>Changelog (v1.5.8)</a></p>
      </div>
    </div>
  </div>
</footer>
    
    
    <div class='elevator' data-component='elevator'>
  <svg version='1.0' viewBox='0 0 32 32' xml:space='preserve' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>
    <polygon points='0.645,10.383 16,23.871 31.355,10.383 29.375,8.129 16,19.878 2.625,8.129 '/>
  </svg>
</div>
    
  </div>
  <script src="../../static/js/vendor.min.js"></script>
  <script src="../../static/js/scripts.min.js"></script>
  

  <!--
    Fathom - simple website analytics - https://github.com/usefathom/fathom
    No personal data is tracked!
  -->
  <script>
    (function(f, a, t, h, o, m){
      a[h]=a[h]||function(){
        (a[h].q=a[h].q||[]).push(arguments)
      };
      o=f.createElement('script'),
      m=f.getElementsByTagName('script')[0];
      o.async=1; o.src=t; o.id='fathom-script';
      m.parentNode.insertBefore(o,m)
    })(document, window, 'http://analytics.timmyomahony.com/tracker.js', 'fathom');
    fathom('set', 'siteId', 'SUOML');
    fathom('trackPageview');
  </script>

  
  <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Django and CircleCI 2.0",
    "description": "excerpt",
    "image": "/media/filer_public/aa/91/aa91849f-924a-43cf-9dd4-e02e70b4bef6/hans-peter-gauster-252751-unsplash.jpg",
    "url": "timmyomahony.com/blog/django-and-circleci-2/",
    "author": {
  "@context": "http://schema.org",
  "@type": "Person",
  "name": "Timmy O&#39;Mahony",
  "url": "http://timmyomahony.com",
  "email": "mailto:hey@timmyomahony.com",
  "gender": "male",
  "image": "http://timmyomahony.com/static/images/timmy-omahony-portrait-small.png",
  "jobTitle": "Software Development",
  "sameAs": [
    "https://github.com/timmyomahony/",
    "http://stackoverflow.com/users/396300/timmy-omahony"
  ]
},
    "datePublished": "2019-05-01",
    "dateModified": "2019-09-12",
  }
  </script>

</body>

<!-- Mirrored from timmyomahony.com/blog/django-and-circleci-2/ by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 03 Feb 2020 07:53:35 GMT -->
</html>
