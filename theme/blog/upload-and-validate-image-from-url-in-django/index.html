

<!DOCTYPE html>
<html>

<!-- Mirrored from timmyomahony.com/blog/upload-and-validate-image-from-url-in-django/ by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 03 Feb 2020 07:56:05 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <meta name='description' content="">
  <meta name='keywords' content=''>  
  <title>Uploading and validating an image from an URL with Django</title>
  
  

<link rel="apple-touch-icon" sizes="180x180" href="../../static/images/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../static/images/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../static/images/favicon/favicon-16x16.png">
<link rel="manifest" href="../../static/images/favicon/site.webmanifest">
<link rel="mask-icon" href="../../static/images/favicon/safari-pinned-tab.svg" color="#67d38a">
<meta name="msapplication-TileColor" content="#67d38a">
<meta name="theme-color" content="#67d38a">
  
  <link rel="stylesheet" href="../../static/css/styles.min.css" type="text/css" charset="utf-8">
  
</head>
<body class='' data-component='body'>
  <div class='page'>
    





<div class='header-wrapper ' data-component='header'>
  <div class='container'>
    <div class='row'>
      <div class='col-xs-12'>
        <header class='header'>
          <div class='header-logo'>
            <a class='header-image' href='../../index.html'>
              <img class='header-image__img' src="../../static/images/timmy-omahony-portrait-small.png" alt="Timmy O&#39;Mahony">
            </a>
            <div class="header-text">
              <a class='header-title link--dark link--no-underline' href='../../index.html'>
                Timmy O&#39;Mahony
              </a>
              <p class='header-subtitle color-xs-light-gray'>
                Software Development
              </p>
            </div>
          </div>
          <nav class='header-nav'>
            <ul class='header-nav__list'>
              <li class='header-nav__item'>
                <a class='header-nav__link ' href='../../index.html'>
                  About
                </a>
              </li>
              <li class='header-nav__item'>
                <a class='header-nav__link header-nav__link--active' href='../index.html'>
                  Blog
                </a>
              </li>
              <li class='header-nav__item hide-xs show-sm'>
                <a class='header-nav__link header-nav__link--light' href='mailto:hey@timmyomahony.com'>
                  hey@timmyomahony.com
                </a>
              </li>
            </ul>
          </nav>
          <button class='header-hamburger button--reset clickable' data-header-hamburger>
            <svg class="svg svg--hamburger" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
              viewBox="0 0 298 87.011" enable-background="new 0 0 298 87.011" xml:space="preserve">
              <rect x="0" fill="#282828" width="298" height="21.505"/>
              <rect y="65.506" fill="#282828" width="298" height="21.505"/>
            </svg>
          </button>
        </header>
      </div>
    </div>
  </div>
  <div class='header-overlay' data-nav-overlay>
    <div class='header-overlay__close' data-header-overlay-close>
      <button class='button button--reset'>
        <svg class='clickable' version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 327.688 327.681" enable-background="new 0 0 327.688 327.681"
           xml:space="preserve">
        <path fill="#231F20" d="M3.004,324.691c1.997,1.997,4.618,2.99,7.24,2.99s5.243-1.004,7.25-3.001l146.35-146.523l146.35,146.523
          c1.997,2.008,4.618,3.001,7.25,3.001c2.621,0,5.243-1.004,7.239-2.99c4.004-3.993,4.004-10.476,0.011-14.479l-146.207-146.37
          L324.684,17.48c3.994-4.003,3.994-10.485-0.01-14.479c-4.015-4.004-10.486-4.004-14.479,0.01l-146.36,146.524L17.484,3.012
          C13.48-0.992,6.998-0.992,3.004,3.001C-1,6.995-1,13.477,2.994,17.48l146.187,146.361L2.994,310.211
          C-1,314.206-1,320.698,3.004,324.691z"/>
        </svg>
      </button>
    </div>
    <div class='header-nav'>
      <ul class='header-nav__list'>
        <li class='header-nav__item'>
          <a class='header-nav__link ' href='../../index.html'>
            About
          </a>
        </li>
        <li class='header-nav__item'>
          <a class='header-nav__link header-nav__link--active' href='../index.html'>
            Blog
          </a>
        </li>
        <li class='header-nav__item'>
          <a class='header-nav__link ' href='../../projects/featured/index.html'>
            Projects
          </a>
        </li>
        <li class='header-nav__item'>
          <a class='header-nav__link header-nav__link--light' href='mailto:hey@timmyomahony.com'>
            hey@timmyomahony.com
          </a>
        </li>
      </ul>
    </div>
  </div>
</div>

    <main class='main'>
      
  <section class='container mt-xs-20 mt-sm-40 mb-xs-120'>
    <div class='row'>
      <div class='col-xs-12 col-md-8 col-md-offset-2'>
        
        
          
            <p class="alert">This post is > 3 years old. Buyer beware</p>
          
        
        

<article class='content-item'>
  <header class='content-item__header'>
    <h1 class='content-item__title'>
      Uploading and validating an image from an URL with Django
    </h1>
    
      <p class='content-item__subtitle'>
        <time class='content-item__date' datetime='' itemprop='datePublished'>
          June 20, 2014
        </time>&mdash;
      </p>
    
  </header>
  
  <div class='content-item__body user-content'>
    <p class="alert">The full code can be seen over on <a href="https://github.com/timmyomahony/django-blog-examples/tree/master/image_uploader">my Github page</a> and has everything needed to see the example live</p>

<p>In this post I&#8217;m going to show how we can go about creating a small app that allows the user to upload an image via an URL. The user will be presented with a single form field in which they can enter an image URL:</p>

<p><img src="../../media/filer_public/5b/b3/5bb39edf-00c2-45c0-8246-cefd6ed8ceb4/upload-validating-images-1.png" alt="Image" /></p>

<p><img src="../../media/filer_public/fb/ea/fbea3075-4dca-47c2-ba1b-fa3e6e460212/upload-validating-images-2.png" alt="Image" /></p>

<p>Both the URL and the corresponding image (if present) will be validated. It will then be downloaded to our application server and finally it will be assigned to a Django model instance. The main steps in this process are as follows:</p>

<ul>
<li>Show the user a form.</li>
<li>Check that the URL is valid (via Django&#8217;s <code>Form</code> class validation).</li>
<li>Check that the URL extension is image-like.</li>
<li>Check that the URL has a valid image mimetype.</li>
<li>Check that the image exists on the remote server.</li>
<li>Check that the image is within a certain size.</li>
<li>Check that the mimetype after opening the file is image-like.</li>
<li>Download the image from the server and assign to an <code>ImageField</code> in a model.</li>
<li>Show the uploaded image.</li>
</ul>

<p>There are a couple of requirements we first need to install before we get started:</p>

<div class="codehilite"><pre><span></span><code><span class="c1"># We will be installing Pillow and need some OS prerequisites. You can see the</span>
<span class="c1"># the full installation guide here:</span>
<span class="c1"># http://pillow.readthedocs.org/en/latest/installation.html</span>

<span class="c1"># OSX (requires brew)</span>
brew install libtiff libjpeg webp little-cms2

<span class="c1"># Ubuntu</span>
sudo apt-get install libtiff4-dev libjpeg8-dev zlib1g-dev libfreetype6-dev liblcms2-dev libwebp-dev tcl8.5-dev tk8.5-dev python-tk

pip install pillow requests python-magic
</code></pre></div>

<p>Now we&#8217;ll go through some of the various functions we are going to use to validate the image file before and after it is downloaded. Some of these have been taken from Stackoverflow answers so I&#8217;ve added the source where relevant. Afterwards we will look at the model, form and view required to tie it all together. If you want to browse the code in full, it can be seen on <a href="https://github.com/timmyomahony/django-blog-examples/tree/master/image_uploader">my Github page</a>.</p>

<h3>Validating the URL&#8217;s extension</h3>

<p>We first look at the URL that the user has supplied and make sure that it ends with a valid image-like extension: <code>.jpg, .jpeg, .png</code> etc. This has the obvious limitation that only URLs that end with a file-like tail such as <code>foo.com/bar.jpeg</code> will be accepted</p>

<div class="codehilite"><pre><span></span><code><span class="n">VALID_IMAGE_EXTENSIONS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;.jpg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.jpeg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.png&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.gif&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">valid_url_extension</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">extension_list</span><span class="o">=</span><span class="n">VALID_IMAGE_EXTENSIONS</span><span class="p">):</span>
    <span class="c1"># http://stackoverflow.com/a/10543969/396300</span>
    <span class="k">return</span> <span class="nb">any</span><span class="p">([</span><span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">extension_list</span><span class="p">])</span>              
</code></pre></div>

<h3>Validating the URL mimetype</h3>

<p>This step is slightly redundant but useful as an alternative to the above file extensions check. We use the <a href="https://docs.python.org/2/library/mimetypes.html">python mimetype</a> library to check the URL and make sure it is image-like.</p>

<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">mimetype</span>
<span class="n">VALID_IMAGE_MIMETYPES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;image&quot;</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">valid_url_mimetype</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">mimetype_list</span><span class="o">=</span><span class="n">VALID_IMAGE_MIMETYPES</span><span class="p">):</span>
    <span class="c1"># http://stackoverflow.com/a/10543969/396300</span>
    <span class="n">mimetype</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mimetype</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">([</span><span class="n">mimetype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mimetype_list</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>

<h3>Validating that the image exists on the server</h3>

<p>Next we check whether or not the resource at the URL supplied by the user actually exists. To do this we make a HEAD request instead of a GET request <a href="https://ochronus.com/http-head-request-good-uses/">which avoids actually having to download the file</a>.</p>

<p>The following code uses <code>httplib</code> but you could <a href="http://stackoverflow.com/q/107405/396300">alternatively use urllib to fetch the file</a></p>

<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">httplib</span>

<span class="k">def</span> <span class="nf">image_exists</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="c1"># http://stackoverflow.com/questions/2486145/python-check-if-url-to-jpg-exists</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;HEAD&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div>

<h3>Validating the image file size remotely</h3>

<p>While we are checking that the file exists on the remote server by making a HEAD request, we can also try <a href="http://stackoverflow.com/a/5617010/396300">to check the size of the file <em>before actually downloading it</em></a>, saving us from fetching a file that exceeds our limitations. We do this by checking the headers for a <a href="http://stackoverflow.com/questions/2773396/whats-the-content-length-field-in-http-header">&#8217;content-length&#8217;</a> key/value which tells us the byte size of the image. Note that there is no error checking in this example. It isn&#8217;t guarenteed that the remote server will actually return a <code>content-length</code> header nor that the value will be correct so use with caution.</p>

<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">httplib</span>

<span class="k">def</span> <span class="nf">image_exists</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">check_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">size_limit</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;HEAD&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">getheaders</span><span class="p">()</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">headers</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;content-length&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">MAX_SIZE</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div>

<h3>Fetching the image</h3>

<p>There are numerous ways of downloading the file from the remote server. We want to simply grab the image from the URL without saving it to disk as we are going to perform some validation on the image before writing it. For this reason, we use the <code>StringIO</code> library to write the image as a string.</p>

<p>The easiest approach for downloading the image is to use <a href="http://docs.python-requests.org/en/latest/"><code>python-requests</code></a></p>

<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">StringIO</span>

<span class="k">def</span> <span class="nf">retrieve_image</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</code></pre></div>

<p>but you could just as easily use <code>urllib2</code></p>

<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">StringIO</span>

<span class="k">def</span> <span class="nf">retrieve_image</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</code></pre></div>

<h3>Validating the file mimetype</h3>

<p>Once we have the image downloaded we can do a more detailed check for the mimetype. Here we are using the <a href="https://github.com/ahupp/python-magic"><code>python-magic</code></a> library to look inside the downloaded file.</p>

<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">magic</span>

<span class="n">VALID_IMAGE_MIMETYPES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;image&quot;</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">get_mimetype</span><span class="p">(</span><span class="n">fobject</span><span class="p">):</span>
    <span class="n">mime</span> <span class="o">=</span> <span class="n">magic</span><span class="o">.</span><span class="n">Magic</span><span class="p">(</span><span class="n">mime</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mimetype</span> <span class="o">=</span> <span class="n">mime</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">fobject</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>
    <span class="n">fobject</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mimetype</span>

<span class="k">def</span> <span class="nf">valid_image_mimetype</span><span class="p">(</span><span class="n">fobject</span><span class="p">):</span>
    <span class="c1"># http://stackoverflow.com/q/20272579/396300</span>
    <span class="n">mimetype</span> <span class="o">=</span> <span class="n">get_mimetype</span><span class="p">(</span><span class="n">fobject</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mimetype</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mimetype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>

<h3>Validating the image file size locally</h3>

<p>Now that we have the file in memory we can check whether or not the image dimensions are definitely within our limitations. We have already potentially checked this remotely using the <code>content-length</code> header but as that is not guarenteed to exist or be correct so this is a good secondary check.</p>

<p>The following function takes a PIL image as a parameter. This conversion from <code>StringIO</code> to PIL image takes place in our class view which we will look at in a minute.</p>

<div class="codehilite"><pre><span></span><code><span class="n">MAX_SIZE</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span>

<span class="k">def</span> <span class="nf">valid_image_size</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="n">MAX_SIZE</span><span class="p">):</span>
    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">height</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Image is too large&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</code></pre></div>

<h3>Other Utility Functions</h3>

<p>The following are some other utility functions that we will make use of in our form and view.</p>

<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">StringIO</span>
<span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">from</span> <span class="nn">django.core.files.base</span> <span class="kn">import</span> <span class="n">ContentFile</span>

<span class="k">def</span> <span class="nf">split_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">parse_object</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parse_object</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span> <span class="n">parse_object</span><span class="o">.</span><span class="n">path</span>

<span class="k">def</span> <span class="nf">get_url_tail</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  

<span class="k">def</span> <span class="nf">get_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">pil_to_django</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;JPEG&quot;</span><span class="p">):</span>
    <span class="c1"># http://stackoverflow.com/questions/3723220/how-do-you-convert-a-pil-image-to-a-django-file</span>
    <span class="n">fobject</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fobject</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">fobject</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</code></pre></div>

<h3>The Model</h3>

<p>Our Django model is very basic, we just use a <code>models.ImageField</code> to hold a reference to our downloaded image. Again, we will need to do some conversions in our view to get our <code>StringIO</code> to a Django image. We also dynamically modify the filename of our downloaded image file, adding a date and time value to ensure uniqueness. This is really down to your own requirements.</p>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">django.utils.text</span> <span class="kn">import</span> <span class="n">slugify</span>

<span class="n">UPLOAD_PATH</span> <span class="o">=</span> <span class="s2">&quot;image_uploader/&quot;</span>

<span class="k">class</span> <span class="nc">UploadedImage</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">generate_upload_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slugify</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">.%H-%M-%S&quot;</span><span class="p">),</span> <span class="n">ext</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">UPLOAD_PATH</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">upload_to</span><span class="o">=</span><span class="n">generate_upload_path</span><span class="p">)</span>
</code></pre></div>

<h3>The Form</h3>

<p>In validating the form, we just want to make sure that the <em>URL</em> submitted is correct - this is processed by the underlying Django <code>URLField</code>. Note that we don&#8217;t do any actual checks on the file yet - this will happen at the view level.</p>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>


<span class="k">class</span> <span class="nc">UploadURLForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">error_messages</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="s2">&quot;Please enter a valid URL to an image (.jpg .jpeg .png)&quot;</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">clean_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">domain</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">split_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_url_extension</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">valid_url_mimetype</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Not a valid Image. The URL must have an image extensions (.jpg/.jpeg/.png)&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">url</span>
</code></pre></div>

<h3>The Views</h3>

<p>We add our custom validation to the <code>form_valid</code> method of our view. Because we have extended the form&#8217;s <code>clean_url</code> method, we can be sure that by the time <code>form_valid</code> is called we have a valid URL value that at least looks like it&#8217;s a valid image.</p>

<p>We then use our validation methods from above. We check that the image exists on the server, we make sure it is a valid image by checking it&#8217;s mimetype and we make sure it is within our dimension limiations. We then save it to our model&#8217;s <code>ImageField</code>.</p>

<p>Finally, we have a very simple second view for showing the image once it&#8217;s downloaded</p>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">django.views.generic.edit</span> <span class="kn">import</span> <span class="n">FormView</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">DetailView</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>

<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">UploadURLForm</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">UploadedImage</span>


<span class="k">class</span> <span class="nc">UploadURLView</span><span class="p">(</span><span class="n">FormView</span><span class="p">):</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">UploadURLForm</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;image_uploader/upload.html&quot;</span>

    <span class="k">def</span> <span class="nf">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;upload-detail&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uploaded_image</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="p">])</span>

    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_invalidate</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
            <span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">,</span> <span class="p">]</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">UploadURLView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_invalid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
        <span class="n">domain</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">split_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">get_url_tail</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">image_exists</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_invalidate</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t retreive image. (There was an error reaching the server)&quot;</span><span class="p">))</span>

        <span class="n">fobject</span> <span class="o">=</span> <span class="n">retrieve_image</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_image_mimetype</span><span class="p">(</span><span class="n">fobject</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_invalidate</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Downloaded file was not a valid image&quot;</span><span class="p">))</span>

        <span class="n">pil_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fobject</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_image_size</span><span class="p">(</span><span class="n">pil_image</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">_invalidate</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Image is too large (&gt; 4mb)&quot;</span><span class="p">))</span>

        <span class="n">django_file</span> <span class="o">=</span> <span class="n">pil_to_django</span><span class="p">(</span><span class="n">pil_image</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uploaded_image</span> <span class="o">=</span> <span class="n">UploadedImage</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uploaded_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">django_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uploaded_image</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">UploadURLView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">UploadDetailView</span><span class="p">(</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">UploadedImage</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s2">&quot;image&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;image_uploader/detail.html&quot;</span>
</code></pre></div>

<p>This is a great start in offering the user a dialog for uplodaing images from various sources. It could be integrated into a popup dialog that allows users to upload images from Google image searches, traditional uploads, ajax multi-uploads as well as URLs. Examples of these may even come in later blog posts.</p>

  </div>
  <footer class='content-item__footer mt-xs-80'>
    <p class='list-item__tags'>
      
        <a href='../category/web-development/index.html'>Web Development</a> &mdash;
      
      
        
          <a href='../tag/django/index.html'>Django</a>
        
      
    </p>
    
      <p class='list-item__tags'>
        Last edited 4 months, 3 weeks ago
      </p>
        
  </footer>
</article>
      </div>
    </div>
    
      <footer class='row'>   
        <div class='col-xs-12 col-md-8 col-md-offset-2 center-xs mt-xs-80'>
          <a class='button' href='#' data-component='comments'>
            Load Comments
          </a>
          <div id='disqus_thread'></div>
        </div>
      </footer>
    
  </section>

    </main>
    
    

<footer class='footer'>
  <div class='container'>
    <div class='row mb-xs-40 mb-sm-60'>
      <div class='col-xs-12 col-md-5'>
        <h3>Timmy O&#39;Mahony</h3>
        <p><a class='email' href='mailto:hey@timmyomahony.com'>hey@timmyomahony.com</a></p>
        <p>I’m a software developer. I can help you solve 
        a problem, build a product or grow existing project.</p>
      </div>
    </div>

    <div class='row mb-xs-40 mb-ms-80'>
      
      <div class='col-xs-12 col-sm-6 col-md-4 mb-xs-40'>
        <h4 class='mb-xs-20 mb-sm-40'>Menu</h4>
        <div class="row">
          <div class="col-xs-6">
            <ul class='list--reset'>
              <li>
                <a href='../../index.html'>About</a>
              </li>
              <li>
                <a href='../index.html'>Blog</a>
              </li>
              <li>
                <a href='../../projects/featured/index.html'>Projects</a>
              </li>
              <li>
                <span>&mdash;</span>
              </li>
              <li>
                <a href='../../privacy/index.html'>Privacy</a>
              </li>
            </ul>
          </div>
          <div class="col-xs-6">
            <ul class='list--reset'>
              <li>
                <a class="link--dark" href='../../books/index.html'>Books</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      
      <div class='col-xs-12 col-sm-6 col-md-4 col-md-offset-1 mb-xs-40'>
        <h4 class='mb-xs-20 mb-sm-40'>Contact</h4>
        <ul class='list--reset'>
          <li>
            <a href='mailto:hey@timmyomahony.com'>
              hey@timmyomahony.com
            </a>
            <a class="link--dark" href='../../pgp-key/index.html'>
              (pgp)
            </a>
          </li>
          <li>
            <a href='skype:live:timmyomahony' target='_blank' title='Skype me'>
              Skype
            </a>
          </li>
        </ul>
      </div>
      
      <div class='col-xs-12 col-sm-6 col-md-3 mb-xs-40'>
        <h4 class='mb-xs-20 mb-sm-40'>Online</h4>
        <ul class='list--reset'>
          <li>
            <a href='https://github.com/timmyomahony/' target='_blank' title='Look through my Github profile'>
              Github
            </a>
          </li>
          <li>
            <a href='https://twitter.com/timmyomahony/' target='_blank' title='Look through my Twitter profile'>
              Twitter
            </a>
          </li>
          <li>
            <a href='http://stackoverflow.com/users/396300/timmy-omahony' target='_blank' title='See my Stack Overflow profile'>
              Stack Overflow
            </a>
          </li>
        </ul>
      </div>
    </div>
    
    <div class='row'>
      <div class='col-xs-12'>
        <p class='copyright'>Copyright Timmy O’Mahony 2020 &copy; <a class='link--underline' href='../../about-this-site/index.html'>More information</a>  — <a class='link--dark' href='../../changelog/index.html'>Changelog (v1.5.8)</a></p>
      </div>
    </div>
  </div>
</footer>
    
    
    <div class='elevator' data-component='elevator'>
  <svg version='1.0' viewBox='0 0 32 32' xml:space='preserve' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>
    <polygon points='0.645,10.383 16,23.871 31.355,10.383 29.375,8.129 16,19.878 2.625,8.129 '/>
  </svg>
</div>
    
  </div>
  <script src="../../static/js/vendor.min.js"></script>
  <script src="../../static/js/scripts.min.js"></script>
  

  <!--
    Fathom - simple website analytics - https://github.com/usefathom/fathom
    No personal data is tracked!
  -->
  <script>
    (function(f, a, t, h, o, m){
      a[h]=a[h]||function(){
        (a[h].q=a[h].q||[]).push(arguments)
      };
      o=f.createElement('script'),
      m=f.getElementsByTagName('script')[0];
      o.async=1; o.src=t; o.id='fathom-script';
      m.parentNode.insertBefore(o,m)
    })(document, window, 'http://analytics.timmyomahony.com/tracker.js', 'fathom');
    fathom('set', 'siteId', 'SUOML');
    fathom('trackPageview');
  </script>

  
  <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Uploading and validating an image from an URL with Django",
    "description": "excerpt",
    
    "url": "timmyomahony.com/blog/upload-and-validate-image-from-url-in-django/",
    "author": {
  "@context": "http://schema.org",
  "@type": "Person",
  "name": "Timmy O&#39;Mahony",
  "url": "http://timmyomahony.com",
  "email": "mailto:hey@timmyomahony.com",
  "gender": "male",
  "image": "http://timmyomahony.com/static/images/timmy-omahony-portrait-small.png",
  "jobTitle": "Software Development",
  "sameAs": [
    "https://github.com/timmyomahony/",
    "http://stackoverflow.com/users/396300/timmy-omahony"
  ]
},
    "datePublished": "2014-06-20",
    "dateModified": "2019-09-13",
  }
  </script>

</body>

<!-- Mirrored from timmyomahony.com/blog/upload-and-validate-image-from-url-in-django/ by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 03 Feb 2020 07:56:07 GMT -->
</html>
